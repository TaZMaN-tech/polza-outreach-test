# Архитектура системы Email Outreach

**Цель:** 1200 email аккаунтов, мульти-клиент, минимальная стоимость инфраструктуры, высокая доступность

---

## 1. Компоненты системы

```
┌─────────────────┐
│   API Gateway   │ ← Клиентские запросы (REST/GraphQL)
└────────┬────────┘
         │
┌────────▼────────┐
│  Queue Manager  │ ← Redis (очередь задач, rate limiting)
└────────┬────────┘
         │
┌────────▼────────────────────┐
│   Worker Pool (3-5 нод)     │ ← Python workers (отправка писем)
└────────┬────────────────────┘
         │
┌────────▼────────┐
│  SMTP Rotator   │ ← 15-20 SMTP аккаунтов (логика ротации)
└────────┬────────┘
         │
┌────────▼────────┐
│  External SMTP  │ ← Gmail Workspace, SendGrid, SMTP2GO
└─────────────────┘

Мониторинг: Prometheus + Grafana + Sentry
Хранилище: PostgreSQL (кампании, статистика, доставляемость)
```

---

## 2. Инфраструктура

**Хостинг:** DigitalOcean/Hetzner VPS (3 ноды)
- **Нода 1:** API + PostgreSQL + Redis (4GB RAM, 2 vCPU) — $24/мес
- **Ноды 2-3:** Workers (2GB RAM, 1 vCPU каждая) — $12/мес × 2 = $24/мес

**Контейнеризация:** Docker Compose (оркестрация избыточна для такого масштаба)
- API контейнер (FastAPI/Flask)
- Worker контейнеры (Python + Celery)
- Redis контейнер
- PostgreSQL контейнер

**Развёртывание:** GitLab CI/CD → SSH deploy (k8s не нужен)

---

## 3. Пул SMTP аккаунтов

**Стратегия:** 15-20 аккаунтов у 3-4 провайдеров для распределения рисков

### Микс провайдеров
- **Gmail Workspace:** 5 аккаунтов ($6/пользователь/мес × 5 = $30/мес)
  - Лимит: 500 писем/день на аккаунт → 2,500/день всего
  - Репутация: Отличная (IP пул Google)

- **SendGrid API:** Бесплатный тариф + Платный ($20/мес)
  - Лимит: 100/день бесплатно, далее $0.0006/письмо
  - Использование для транзакционных/высокоприоритетных

- **SMTP2GO/Mailgun:** 5 аккаунтов ($10/мес всего)
  - Лимит: 1,000/день на аккаунт → 5,000/день
  - Резервный пул

- **Кастомный SMTP (если бюджет позволяет):** 5 аккаунтов на отдельном VPS
  - VPS с Postfix: $6/мес
  - 5 разных /24 IP через ротацию прокси

### Логика ротации
```python
# Round-robin with health check
accounts = [acc for acc in smtp_pool if acc.is_healthy()]
account = accounts[campaign_id % len(accounts)]

# Respect daily limits
if account.today_sent >= account.daily_limit * 0.9:
    account = get_next_available()
```

### Настройка доменов
- **5 доменов:** $12/год × 5 = $5/мес
- SPF: `v=spf1 include:_spf.google.com include:sendgrid.net ~all`
- DKIM: Ротация ключей каждые 3 месяца
- DMARC: `v=DMARC1; p=none; rua=mailto:dmarc@domain.com` (сначала мониторинг)

---

## 4. Очередь и Rate Limiting

**Очередь:** Redis + Celery
```python
# Задача кампании
@celery.task(rate_limit='100/m')  # 100 писем/мин на всю систему
def send_email(recipient, template, smtp_account_id):
    account = get_smtp_account(smtp_account_id)

    # Rate limiting по аккаунтам
    if account.minute_sent >= 10:  # 10/мин на аккаунт
        raise Retry(countdown=60)

    send_via_smtp(account, recipient, template)
```

**Rate Limits (чтобы избежать спам-флагов):**
- **На всю систему:** 100 писем/мин
- **На аккаунт:** 10 писем/мин, 500/день (для Gmail)
- **На домен:** 50 писем/день (защита целевого домена)
- **На домен получателя:** Макс 20 писем/день (например, @company.com)

**Стратегия backoff:**
- Неудачная отправка → повтор через 5мин, 15мин, 1ч
- 3 неудачи → пауза аккаунта на 24ч
- 5XX ошибки → немедленный переход на следующий аккаунт

---

## 5. Мониторинг

**Метрики (Prometheus):**
- Отправлено/не отправлено писем на аккаунт (за 1ч, 24ч)
- Глубина очереди, утилизация worker'ов
- SMTP коды ответов (2XX, 4XX, 5XX)
- Процент доставки по доменам
- Bounce rate по кампаниям

**Алерты (AlertManager → Telegram):**
- Дневной лимит аккаунта >80% → переключение на резервный
- Bounce rate >10% → пауза кампании
- SMTP 5XX ошибки >5/мин → health check аккаунта
- Worker недоступен >5мин → перезапуск контейнера

**Логирование (ELK или Loki):**
- Структурированные логи: `{account_id, recipient_domain, smtp_code, timestamp}`
- Хранение: 30 дней

**Мониторинг блеклистов:**
- Ежедневная проверка: MXToolbox API ($50/мес) или self-hosted скрипт
- Проверка всех отправляющих IP против Spamhaus, SpamCop, Barracuda

---

## 6. Отказоустойчивость

### Отказ SMTP аккаунта
```
Аккаунт заблокирован → Пометить как unhealthy → Переключиться на резервный пул
Health check каждые 30мин (тестовая отправка на свой адрес)
Авто-восстановление через 24ч если health check пройден
```

### Падение репутации домена
```
Всплеск bounce rate → Пауза домена → Переключение на резервный домен
DMARC отчёты показывают ошибки → Немедленное исправление SPF/DKIM
```

### Отказ Worker/Сервера
```
Нода недоступна → Celery задачи автоматически возвращаются в очередь (Redis persistent)
PostgreSQL недоступен → Read replica на ноде 2 (async репликация)
Redis недоступен → Worker graceful crash, перезапуск с очередью
```

**Стратегия резервного копирования:**
- PostgreSQL: Ежедневный дамп в S3-совместимое хранилище ($5/мес за 50GB)
- Redis: RDB снапшоты каждые 6ч
- Конфиг/секреты: Зашифровано в Git репозитории

---

## 7. Минимизация рисков

### Детекция спама
- **Прогрев:** Новые аккаунты начинают с 50/день, +50/день до лимита
- **Контент:** Избегать спам-слов, персонализация через {name}/{company}
- **Ссылка отписки:** Обязательна (юридически + доставляемость)
- **Вовлечённость:** Трекинг открытий/кликов, удаление невовлечённых после 3 кампаний

### Блеклисты
- **Профилактика:** Учитывать bounces, чистые списки (сначала проверка email инструментом из Задачи 1)
- **Мониторинг:** Ежедневная проверка IP/доменов
- **Исправление:** Запросы на удаление из блеклистов (вручную, 24-48ч)

### DMARC/SPF/DKIM
- **SPF:** Включить IP всех провайдеров (`include:`)
- **DKIM:** Ротация ключей ежеквартально, 2048-бит
- **DMARC:** Старт с `p=none` (мониторинг), переход на `p=quarantine` через 1 месяц чистых отчётов

### Управление репутацией
- **Раздельные пулы:** Транзакционные (Gmail) vs. холодный outreach (SMTP2GO)
- **Feedback loops:** Подписка на FBL провайдеров (Gmail Postmaster Tools)
- **Гигиена списков:** Удаление hard bounces немедленно, soft bounces после 3 попыток

### Юридические риски
- **GDPR:** Требуется согласие (opt-in), отписка в 1 клик
- **CAN-SPAM:** Физический адрес в футере, обработка opt-out в течение 10 дней
- **Хранение данных:** Пользователи из ЕС → хранение в регионе ЕС (Hetzner Германия)

---

## 8. Оценка стоимости (в месяц)

| Позиция | Детали | Стоимость |
|---------|--------|-----------|
| **VPS** | 3 ноды (DigitalOcean/Hetzner) | $48 |
| **PostgreSQL** | Включено в VPS | $0 |
| **Redis** | Включено в VPS | $0 |
| **SMTP аккаунты** | 5× Gmail Workspace ($6/пользователь) | $30 |
| **SMTP аккаунты** | SendGrid платный | $20 |
| **SMTP аккаунты** | SMTP2GO/Mailgun | $10 |
| **Домены** | 5 доменов @ $12/год | $5 |
| **Мониторинг** | Grafana Cloud Free + Sentry Free | $0 |
| **Резервное хранилище** | S3-совместимое (50GB) | $5 |
| **Проверка блеклистов** | MXToolbox API или self-hosted | $0-50 |
| **SSL сертификаты** | Let's Encrypt | $0 |
| **Прокси/IP (опционально)** | Ротирующие прокси для SMTP | $0-30 |
| **Итого** | Базовая настройка | **$118-168/мес** |

**Масштабирование до 10k писем/день:** +$50/мес (больше SMTP аккаунтов, более мощный VPS)

---

## 9. Операционный процесс

**Создание кампании:**
```
1. Клиент → API: Загрузка CSV, шаблон
2. API → Валидация email (инструмент из Задачи 1), сохранение в PostgreSQL
3. API → Создание Celery задач (1 на получателя)
4. Очередь → Назначение SMTP аккаунта (ротация + health check)
5. Worker → Отправка письма, логирование результата
6. Повтор неудачных → Exponential backoff
7. Обновление статистики → PostgreSQL (отправлено, bounced, открыто)
```

**Ежедневное обслуживание:**
```
- Health check SMTP аккаунтов (автоматически)
- Просмотр DMARC отчётов (вручную, 10мин)
- Проверка статуса блеклистов (автоматический алерт)
- Анализ bounce rate по доменам (дашборд)
```

---

## 10. Путь масштабирования

**0-5k писем/день:** Текущая архитектура (3 ноды, 15 аккаунтов)

**5k-20k писем/день:**
- Добавить 2 worker ноды (+$24/мес)
- Добавить 10 SMTP аккаунтов (+$60/мес)
- Апгрейд ноды 1 до 8GB RAM (+$24/мес)

**20k-100k писем/день:**
- Миграция на managed SMTP (SendGrid $80/мес за 40k)
- Добавить Redis Cluster (3 ноды для HA)
- Горизонтальное масштабирование worker'ов (5-10 нод)

---

## Итоги

**Философия:** Начинать с минимума, масштабировать постепенно. Избегать over-engineering (не нужен Kubernetes для 1200 писем/день). Фокус на доставляемости, а не на throughput — репутацию восстанавливать сложнее, чем инфраструктуру.

**Ключевые метрики успеха:**
- Процент доставки >95%
- Bounce rate <5%
- Ноль инцидентов с блеклистами в первые 3 месяца
- Uptime >99.5%

**Сроки до продакшн:** 2-3 недели (1 неделя разработка, 1 неделя тестирование/прогрев, 1 неделя мониторинг)
